<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Windows 2000 Simulator + Buddy + Explorer Completo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
*{box-sizing:border-box;user-select:none;cursor:url('assets/cursor.cur'),default}
body{margin:0;height:100vh;font-family:Tahoma,Verdana,sans-serif;background:#000;overflow:hidden}
#boot{position:fixed;inset:0;background:#000;color:#ccc;display:flex;align-items:center;justify-content:center;font-size:18px; z-index: 9999;}
#boot span{animation:blink 1s steps(2,start) infinite}
@keyframes blink{to{visibility:hidden}}
#desktop{display:none;height:100vh;background:url('assets/wallpaper.jpg') center/cover no-repeat; position: relative;}
.icons{padding:20px;color:#fff; display: flex; flex-direction: column; flex-wrap: wrap; height: 90vh; align-content: flex-start;}
.icon{width:90px;text-align:center;margin-bottom:28px;cursor:pointer}
.icon img{width:48px;height:48px; object-fit: contain;} /* Ajuste para icones personalizados n√£o distorcerem */
.icon span{display:block;font-size:13px;text-shadow:1px 1px 2px #000}
.taskbar{position:absolute;bottom:0;left:0;width:100%;height:32px;background:linear-gradient(#245edb,#1941a5);display:flex;align-items:center;padding:0 6px;color:#fff;font-size:13px; z-index: 1000;}
.start-btn{background:linear-gradient(#3aa655,#2e7d32);padding:4px 12px;border-radius:3px;font-weight:bold;cursor:pointer}
.start-menu{position:absolute;bottom:32px;left:0;width:220px;background:#ece9d8;border:2px solid #000080;display:none; z-index: 2000;}
.start-menu div{padding:8px;font-size:13px;cursor:pointer}
.start-menu div:hover{background:#000080;color:#fff}

/* MENU DE CONTEXTO (CLIQUE DIREITO) */
#contextMenu { display: none; }

/* JANELAS PADR√ÉO */
.window{position:absolute;top:15%;left:20%;width:380px;background:#ece9d8;border:2px solid #000080;box-shadow:4px 4px 0 rgba(0,0,0,.4);display:none; z-index: 100;}
.titlebar{background:linear-gradient(#000080,#000060);color:#fff;padding:4px 8px;font-size:13px;cursor:move; display:flex; justify-content:space-between; align-items:center;}
.titlebar .close-x { cursor: pointer; font-weight: bold; padding: 0 5px; }
.content{padding:16px;font-size:14px;color:#000}

/* ESTILOS DO EXPLORER */
#explorerWindow { width: 600px; height: 450px; display: none; flex-direction: column; z-index: 104; }
.exp-toolbar { background: #ece9d8; border-bottom: 1px solid #a0a0a0; padding: 4px; display: flex; align-items: center; gap: 5px; }
.exp-address-bar { background: #ece9d8; padding: 4px; display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #a0a0a0; font-size: 12px; }
.exp-address-input { width: 100%; border: 1px solid #7f9db9; padding: 2px; font-family: Tahoma, sans-serif; margin-top: 0; }
.exp-body { flex-grow: 1; display: flex; background: #fff; border: 2px solid #808080; border-style: inset; margin: 2px; }
.exp-sidebar { width: 150px; background: #fff; border-right: 1px solid #ccc; padding: 5px; overflow-y: auto; font-size: 12px; }
.exp-main { flex-grow: 1; padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); grid-auto-rows: 90px; gap: 5px; }
.exp-item { text-align: center; cursor: pointer; padding: 5px; border: 1px solid transparent; position: relative; }
.exp-item:hover { border: 1px solid #ccc; background: #f0f0f0; }
.exp-item.selected { background: #000080; color: #fff; border: 1px dotted #fff; }
.exp-item img { width: 32px; height: 32px; display: block; margin: 0 auto 4px auto; object-fit: contain; }
.exp-btn { border: 1px solid #808080; background: #ece9d8; padding: 2px 8px; font-size: 11px; cursor: pointer; margin-top: 0; display: flex; align-items: center; gap: 3px; }
.exp-btn:active { border-style: inset; }

/* TEXT EDITOR */
#textEditorWindow { width: 500px; height: 400px; z-index: 110; display: none; flex-direction: column; }
#notepad-area { flex-grow: 1; resize: none; border: none; padding: 5px; font-family: 'Courier New', monospace; outline: none; }

/* APPS (IFRAME) */
#appWindow { top: 10%; left: 10%; width: 800px; height: 600px; display: none; z-index: 102; display: flex; flex-direction: column;}
#appWindow .content { padding: 0; flex-grow: 1; height: 100%; background: #fff; border-top: 2px solid #fff; border-left: 2px solid #fff; border-right: 2px solid #808080; border-bottom: 2px solid #808080;}
iframe { width: 100%; height: 100%; border: none; display: block; }

/* CALCULADORA */
#calcWindow { width: 250px; height: auto; z-index: 103; }
.calc-content { padding: 10px; background: #ece9d8; }
.calc-display {
    width: 100%; height: 35px; background: #fff; border: 2px solid #888; border-style: inset;
    text-align: right; font-family: 'Courier New', monospace; font-size: 20px; padding: 5px; margin-bottom: 10px; color: #000;
}
.calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
.calc-btn {
    height: 35px; font-weight: bold; font-size: 14px; cursor: pointer; background: #ece9d8;
    border: 2px solid #fff; border-right-color: #444; border-bottom-color: #444; color: #000;
}
.calc-btn:active { border: 2px solid #444; border-right-color: #fff; border-bottom-color: #fff; transform: translate(1px, 1px); }
.span-2 { grid-column: span 2; width: 100%; }
.text-red { color: #a00; }

/* INVESTIGA√á√ÉO */
#notesWindow { 
    top: 5%; left: 5%; width: 750px; height: 500px; 
    display: none; z-index: 105; 
    flex-direction: column;
    resize: both; 
    overflow: hidden;
    min-width: 300px; min-height: 200px;
    background: #ece9d8;
}
#notesWindow .toolbar {
    background: #ece9d8; padding: 5px; border-bottom: 1px solid #999; display: flex; gap: 5px; align-items: center; flex-wrap: wrap;
}
#notesWindow .toolbar button { margin: 0; padding: 2px 8px; font-size: 11px; cursor: pointer;}
#notesWindow .toolbar span { font-size: 11px; margin-left: 10px; color: #555; }

/* Viewport (Janela de visualiza√ß√£o) */
#board-viewport { flex-grow: 1; position: relative; overflow: hidden; background: #333; cursor: default; }
#board-content {
    width: 3000px; height: 3000px;
    background: #5c4033;
    background-image: radial-gradient(#6d4c3d 15%, transparent 16%), radial-gradient(#6d4c3d 15%, transparent 16%);
    background-size: 20px 20px;
    background-position: 0 0, 10px 10px;
    transform-origin: 0 0;
    position: absolute; top: 0; left: 0;
    box-shadow: 0 0 50px rgba(0,0,0,0.8);
}
.board-item {
    position: absolute; cursor: grab;
    box-shadow: 3px 3px 5px rgba(0,0,0,0.5);
    padding: 10px; font-family: 'Courier New', Courier, monospace; font-size: 14px;
    max-width: 250px; word-wrap: break-word; user-select: none; transition: box-shadow 0.2s;
}
.board-item:active { cursor: grabbing; }
.board-item.selected { outline: 2px dashed red; box-shadow: 0 0 15px rgba(255,0,0,0.5); }
.delete-btn {
    position: absolute; top: -8px; right: -8px; width: 20px; height: 20px;
    background: red; color: white; border-radius: 50%; text-align: center;
    line-height: 18px; font-weight: bold; font-family: Arial, sans-serif;
    font-size: 12px; border: 1px solid #fff; cursor: pointer; display: none; z-index: 10;
}
.board-item:hover .delete-btn { display: block; }
.note-yellow { background: #ffff88; color: #000; border-bottom-right-radius: 20px; }
.note-yellow:before { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 40px; height: 15px; background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.2); }
.board-photo { background: #fff; padding: 10px 10px 30px 10px; transform: rotate(-2deg); }
.board-photo img { max-width: 200px; max-height: 200px; display: block; border: 1px solid #ccc; pointer-events: none; }
#lines-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

input{width:100%;padding:6px;margin-top:10px}
button{padding:6px 12px;font-size:13px;margin-top:10px}
#bsod{display:none;position:fixed;inset:0;background:#0000aa;color:#fff;font-family:Courier New,monospace;padding:40px;font-size:16px; z-index: 10000;}
a{color:inherit;text-decoration:none}

/* PAINT */
#paintWindow { top: 15%; left: 15%; width: 500px; height: auto; display: none; z-index: 101; }
.paint-toolbar { background: #c0c0c0; padding: 5px; display: flex; gap: 5px; border-bottom: 1px solid #808080; align-items: center; }
.color-swatch { width: 20px; height: 20px; border: 1px solid #000; cursor: pointer; box-shadow: inset 1px 1px 0 #fff, inset -1px -1px 0 #808080; }
.paint-canvas-container { background: #808080; padding: 10px; overflow: hidden; }
canvas { background: #fff; cursor: crosshair; display: block; box-shadow: 2px 2px 0 #000; touch-action: none; }
.paint-btn { margin: 0; padding: 2px 8px; font-size: 11px; }

/* BUDDY */
#buddy-container { position: absolute; bottom: 40px; right: 20px; width: 120px; height: 120px; z-index: 200; cursor: grab; pointer-events: auto; }
#buddy-container:active { cursor: grabbing; }
#buddy-img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5)); transition: transform 0.1s;}
.buddy-dragging #buddy-img { transform: scale(1.1) rotate(5deg); opacity: 0.8; }
.bubble { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #ffffe1; border: 1px solid #000; padding: 10px; border-radius: 4px; box-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size: 12px; color: #000; width: 160px; display: none; z-index: 201; text-align: center; margin-bottom: 10px; }
.bubble:after { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); border-width: 10px 10px 0; border-style: solid; border-color: #ffffe1 transparent; display: block; width: 0; }

/* VISUALIZADOR DE IMAGEM */
#imgViewerWindow { 
    display: none; 
    flex-direction: column; 
    width: 800px; height: 600px; 
    z-index: 250; 
}
.img-toolbar {
    background: #ece9d8; border-bottom: 1px solid #a0a0a0; padding: 5px; 
    display: flex; justify-content: center; gap: 10px; align-items: center;
}
.img-toolbar button { margin: 0; font-weight: bold; width: auto; padding: 2px 10px;}
#imgViewport {
    flex-grow: 1; background: #333; overflow: hidden; position: relative;
    cursor: default; display: flex; align-items: center; justify-content: center;
}
#imgContent {
    max-width: none; max-height: none; 
    transition: transform 0.1s linear;
    transform-origin: center center;
    box-shadow: 0 0 20px #000;
}

/* PLAYER DE VIDEO */
#videoPlayerWindow {
    display: none;
    flex-direction: column;
    width: 600px; height: 450px;
    z-index: 260;
}
#videoViewport {
    flex-grow: 1; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden;
}
video { width: 100%; height: 100%; outline: none; }
</style>
</head>

<body>

<div id="boot">Iniciando Windows 2000<span>_</span></div>

<input type="file" id="wallpaperInput" accept="image/*" style="display:none" onchange="updateWallpaper(this)">
<input type="file" id="imgUploadInput" accept="image/*" style="display:none"> 

<input type="file" id="expImgUpload" accept="image/*,video/mp4,video/webm" style="display:none" onchange="processExpImage(this)"> 
<input type="file" id="customIconInput" accept="image/*" style="display:none" onchange="processCustomIcon(this)">

<input type="file" id="loadBoardInput" accept=".json" style="display:none" onchange="loadBoard(this)">
<input type="file" id="loadSystemInput" accept=".json" style="display:none" onchange="loadSystem(this)">

<div id="contextMenu" class="start-menu" style="width: 200px; position: fixed; z-index: 9999;">
    <div onclick="triggerWallpaperUpload()">Definir Papel de Parede</div>
    <div style="border-top: 1px solid #808080; margin: 2px 0;"></div>
    <div onclick="saveSystem()">üíæ Salvar Estado do PC</div>
    <div onclick="document.getElementById('loadSystemInput').click()">üìÇ Carregar Estado do PC</div>
    <div style="border-top: 1px solid #808080; margin: 2px 0;"></div>
    <div onclick="location.reload()">Atualizar Sistema</div>
</div>

<div id="desktop">
  <div class="icons" onclick="initAudio()">
    <div class="icon" onclick="openExplorer()"><img src="assets/folder.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/directory_open_file_mydocs-4.png'"><span>Meus Documentos</span></div>
    <div class="icon" onclick="openSecret()"><img src="assets/secret.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/key_padlock.png'"><span>Segredo</span></div>
    <div class="icon" onclick="openApp('Internet Explorer', 'https://www.google.com/webhp?igu=1')"><img src="assets/internet.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/msie1.png'"><span>Internet</span></div>
    <div class="icon" onclick="openNotes()"><img src="assets/notes.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/notepad-2.png'"><span>Investiga√ß√£o</span></div>
    <div class="icon" onclick="openCalc()"><img src="assets/calc.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/calculator-0.png'"><span>Calculadora</span></div>
    <div class="icon" onclick="openApp('Conex√£o VPN', 'vpn.html')"><img src="assets/vpn.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/network_cool_two_pcs.png'"><span>VPN</span></div>
    <div class="icon" onclick="openApp('Roblox', 'https://www.roblox.com')"><img src="assets/roblox.png" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/3/3a/Roblox_player_icon_black.svg'"><span>RUblux</span></div>
    <div class="icon" onclick="openPaint()"><img src="assets/paint.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/paint_file-2.png'"><span>Paint</span></div>
    <div class="icon" onclick="openApp('Contribuidores Skyfall', 'https://skyfallcontributors.tiiny.site/')"><img src="assets/users.png" onerror="this.src='https://win98icons.alexmeub.com/icons/png/users-2.png'"><span>Contribuidores</span></div>
  </div>

  <div id="buddy-container" onmousedown="dragBuddy(event)" onclick="interactBuddy()">
     <div class="bubble" id="buddyBubble">Me solta! Hahaha!</div>
     <img id="buddy-img" src="assets/spantu.png" alt="Buddy">
  </div>

  <div class="taskbar">
    <div class="start-btn" onclick="toggleStart()">Iniciar</div>
  </div>

  <div class="start-menu" id="startMenu">
    <div onclick="openExplorer()">Meus Arquivos</div>
    <div onclick="triggerWallpaperUpload()">Mudar Papel de Parede</div>
    <div onclick="openPaint()">Paint</div> 
    <div onclick="openCalc()">Calculadora</div>
    <div onclick="openNotes()">Investiga√ß√£o</div>
    <div onclick="openSecret()">Segredo</div>
    <div onclick="triggerBSOD()">Sistema</div>
    <div onclick="desligar()">Desligar</div>
  </div>

  <div class="window" id="explorerWindow">
    <div class="titlebar" onmousedown="dragExplorer(event)">
        <span>Windows Explorer</span>
        <span class="close-x" onclick="closeExplorer()">X</span>
    </div>
    <div class="exp-toolbar">
        <button class="exp-btn" onclick="expBack()">‚¨Ö Voltar</button>
        <button class="exp-btn" onclick="expUp()">‚¨Ü Acima</button>
        <div style="width:10px"></div>
        <button class="exp-btn" onclick="expNewFolder()">üìÅ Nova Pasta</button>
        <button class="exp-btn" onclick="expNewFile()">üìÑ Novo Texto</button>
        <button class="exp-btn" onclick="expNewImage()">üñºÔ∏è Importar M√≠dia</button>
    </div>
    <div class="exp-address-bar">
        Endere√ßo: <input type="text" id="expAddress" class="exp-address-input" readonly value="C:">
    </div>
    <div class="exp-body">
        <div class="exp-sidebar">
            <div>üìÅ Desktop</div>
            <div>üìÅ Meus Documentos</div>
            <div>üìÅ Meu Computador</div>
            <div style="padding-left:10px">üíæ Disco Local (C:)</div>
        </div>
        <div class="exp-main" id="expContent">
            </div>
    </div>
  </div>

  <div class="window" id="textEditorWindow">
      <div class="titlebar" onmousedown="dragTextEditor(event)">
          <span id="textEditorTitle">Bloco de Notas</span>
          <span class="close-x" onclick="closeTextEditor()">X</span>
      </div>
      <div class="exp-toolbar">
          <button class="exp-btn" onclick="saveCurrentFile()">üíæ Salvar</button>
      </div>
      <div class="content" style="padding:0; height:100%; display:flex;">
          <textarea id="notepad-area"></textarea>
      </div>
  </div>

  <div class="window" id="window">
    <div class="titlebar" onmousedown="drag(event)">
        <span>Sistema</span>
        <span class="close-x" onclick="fechar()">X</span>
    </div>
    <div class="content" id="windowContent"></div>
  </div>

  <div class="window" id="calcWindow">
      <div class="titlebar" onmousedown="dragCalc(event)"><span>Calculadora</span><span class="close-x" onclick="closeCalc()">X</span></div>
      <div class="calc-content">
          <input type="text" class="calc-display" id="calcDisplay" value="0" readonly>
          <div class="calc-grid">
              <button class="calc-btn text-red" onclick="calcClear()">C</button>
              <button class="calc-btn" onclick="calcOp('/')">/</button>
              <button class="calc-btn" onclick="calcOp('*')">*</button>
              <button class="calc-btn" onclick="calcOp('-')">-</button>
              <button class="calc-btn" onclick="calcNum('7')">7</button>
              <button class="calc-btn" onclick="calcNum('8')">8</button>
              <button class="calc-btn" onclick="calcNum('9')">9</button>
              <button class="calc-btn" style="grid-row: span 2;" onclick="calcOp('+')">+</button>
              <button class="calc-btn" onclick="calcNum('4')">4</button>
              <button class="calc-btn" onclick="calcNum('5')">5</button>
              <button class="calc-btn" onclick="calcNum('6')">6</button>
              <button class="calc-btn" onclick="calcNum('1')">1</button>
              <button class="calc-btn" onclick="calcNum('2')">2</button>
              <button class="calc-btn" onclick="calcNum('3')">3</button>
              <button class="calc-btn" style="grid-row: span 2;" onclick="calcEqual()">=</button>
              <button class="calc-btn span-2" onclick="calcNum('0')">0</button>
              <button class="calc-btn" onclick="calcNum('.')">.</button>
          </div>
      </div>
  </div>

  <div class="window" id="notesWindow">
      <div class="titlebar" onmousedown="dragNoteWindow(event)">
          <span>Quadro de Investiga√ß√£o</span>
          <span class="close-x" onclick="closeNotes()">X</span>
      </div>
      <div class="toolbar">
          <button onclick="addSticky()">+ Nota</button>
          <button onclick="triggerImgUpload()">+ Foto (PC)</button>
          <button id="btnConnect" onclick="toggleConnectMode()">üîó Conectar</button>
          <button onclick="saveBoard()">üíæ Salvar</button>
          <button onclick="document.getElementById('loadBoardInput').click()">üìÇ Abrir</button>
          <button onclick="resetView()">Reset Cam</button>
          <span id="zoomLevel">100%</span>
          <span style="color:#000080; margin-left: auto;">(Segure ESPA√áO para mover)</span>
      </div>
      <div id="board-viewport">
          <div id="board-content">
              <svg id="lines-layer"></svg>
              <div id="item1" class="board-item note-yellow" style="top:250px; left:250px;">
                  O culpado usa Windows 98...
              </div>
          </div>
      </div>
  </div>
  
  <div class="window" id="imgViewerWindow">
    <div class="titlebar" onmousedown="dragImgViewer(event)">
        <span id="imgViewerTitle">Visualizador de Imagem</span>
        <span class="close-x" onclick="closeImgViewer()">X</span>
    </div>
    <div class="img-toolbar">
        <button onclick="prevImg()">‚¨Ö Anterior</button>
        <span id="imgZoomDisplay">100%</span>
        <button onclick="nextImg()">Pr√≥xima ‚û°</button>
    </div>
    <div id="imgViewport">
        <img id="imgContent" src="" draggable="false">
    </div>
    <div style="background:#ece9d8; padding:5px; font-size:11px; border-top:1px solid #999;">
        Use a Roda do Mouse para ZOOM | Segure ESPA√áO + Clique para MOVER
    </div>
  </div>

  <div class="window" id="videoPlayerWindow">
    <div class="titlebar" onmousedown="dragVideoPlayer(event)">
        <span id="videoPlayerTitle">Media Player</span>
        <span class="close-x" onclick="closeVideoPlayer()">X</span>
    </div>
    <div id="videoViewport">
        <video id="videoContent" controls>
            Seu navegador n√£o suporta a tag de v√≠deo.
        </video>
    </div>
  </div>

  <div class="window" id="appWindow" style="display:none;">
    <div class="titlebar" onmousedown="dragApp(event)">
        <span id="appTitle">Aplicativo</span>
        <span class="close-x" onclick="closeApp()">X</span>
    </div>
    <div class="content"><iframe id="appFrame" src=""></iframe></div>
  </div>

  <div class="window" id="paintWindow">
    <div class="titlebar" onmousedown="dragPaint(event)"><span>Paint</span><span class="close-x" onclick="closePaint()">X</span></div>
    <div class="paint-toolbar">
        <div class="color-swatch" style="background:#000" onclick="setPaintColor('#000')"></div>
        <div class="color-swatch" style="background:#f00" onclick="setPaintColor('#f00')"></div>
        <div class="color-swatch" style="background:#00f" onclick="setPaintColor('#00f')"></div>
        <div class="color-swatch" style="background:#0f0" onclick="setPaintColor('#0f0')"></div>
        <div class="color-swatch" style="background:#ff0" onclick="setPaintColor('#ff0')"></div>
        <div class="color-swatch" style="background:#fff" onclick="setPaintColor('#fff')"></div>
        <button class="paint-btn" onclick="clearCanvas()">Limpar</button>
    </div>
    <div class="paint-canvas-container">
        <canvas id="canvas" width="460" height="300"></canvas>
    </div>
  </div>
</div>

<div id="bsod">
Um problema foi detectado e o Windows foi desligado para evitar danos.<br><br>
STOP: 0x0000007B<br><br>
Pressione F5 para reiniciar.
</div>

<audio id="click" src="assets/click.wav" preload="auto"></audio>
<audio id="bootSound" src="assets/windows2000.wav" preload="auto"></audio>

<script>
// --- SPEECH API ---
let synth = window.speechSynthesis;
let voices = [];
function loadVoices() { voices = synth.getVoices(); }
loadVoices();
if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = loadVoices; }
function speakText(text) {
  if (isSilentMode) return; // Se estiver em modo silencioso, n√£o fala
  if (synth.speaking) { synth.cancel(); }
  const utterThis = new SpeechSynthesisUtterance(text);
  const googleVoice = voices.find(voice => voice.name.includes('Google') && voice.lang.includes('pt-BR'));
  const anyPtVoice = voices.find(voice => voice.lang.includes('pt-BR'));
  if (googleVoice) { utterThis.voice = googleVoice; } else if (anyPtVoice) { utterThis.voice = anyPtVoice; }
  utterThis.pitch = 1.2; utterThis.rate = 1.1; utterThis.volume = 1;
  synth.speak(utterThis);
}

// --- AUDIO & BOOT ---
let audioUnlocked = true; 
const click = document.getElementById('click');
const bootSound = document.getElementById('bootSound');
function initAudio(){ if(!audioUnlocked) audioUnlocked = true; click.play().then(()=>{ click.pause(); click.currentTime=0; }).catch(()=>{}); }
function playBootSound(){ bootSound.currentTime=0; var promise = bootSound.play(); if (promise !== undefined) { promise.then(_ => { setTimeout(()=>{ bootSound.pause(); bootSound.currentTime=0; }, 6000); }).catch(error => { console.log("Autoplay bloqueado pelo navegador."); }); } }
function play(){ if(audioUnlocked){ click.currentTime=0; click.play().catch(()=>{}); } }
setTimeout(()=>{ document.getElementById('boot').style.display='none'; document.getElementById('desktop').style.display='block'; buddyTalk("Bem-vindo de volta, usu√°rio."); startRandomTalkLoop(); },2500);

// --- JANELAS GERAIS ---
function toggleStart(){ play(); const m=document.getElementById('startMenu'); m.style.display=m.style.display==='block'?'none':'block'; }
function showWindow(html){ play(); document.getElementById('windowContent').innerHTML=html; document.getElementById('window').style.display='block'; }
function fechar(){document.getElementById('window').style.display='none'}
function openSecret(){ if(localStorage.getItem('unlocked')){ showWindow('ACESSO LIBERADO<br>O v√©u caiu.<br><br><button onclick="fechar()">Fechar</button>'); }else{ showWindow('Digite a senha:<input id="pwd" type="password"><button onclick="checkPwd()">OK</button><button onclick="fechar()">Cancelar</button>'); buddyTalk("A senha? Talvez o 'olvido' saiba."); } }
function checkPwd(){ const v=document.getElementById('pwd').value.toLowerCase(); if(v==='o involucro do veu esconde a dor do olvido'){ localStorage.setItem('unlocked','true'); showWindow('ACESSO CONCEDIDO<br>Mem√≥ria restaurada.<br><button onclick="fechar()">Fechar</button>'); buddyTalk("Finalmente... liberdade."); }else{ showWindow('Senha incorreta<br><button onclick="fechar()">Fechar</button>'); buddyTalk("Errado. Tente novamente."); } }
function triggerBSOD(){ play(); document.getElementById('desktop').style.display='none'; document.getElementById('bsod').style.display='block'; }
function desligar(){ document.body.innerHTML='<div style="background:#000;color:#fff;height:100vh;display:flex;align-items:center;justify-content:center">Agora √© seguro desligar o computador</div>'; }
document.addEventListener('keydown',e=>{ if(e.key==='F5'){ localStorage.clear(); location.reload() } });

// --- L√ìGICA DO EXPLORER (SISTEMA DE ARQUIVOS) ---
const explorerWindow = document.getElementById('explorerWindow');
const expContent = document.getElementById('expContent');
const expAddress = document.getElementById('expAddress');
let currentPath = "C:";

// Estrutura de arquivos
let fileSystem = {
    "C:": [
        { name: "Meus Documentos", type: "folder" },
        { name: "Windows", type: "folder" },
        { name: "Arquivos de Programas", type: "folder" },
        { name: "segredos.log", type: "file", icon: "notepad", content: "C√ìDIGO: ???" },
        { name: "???", type: "folder", password: "partitura" }
    ],
    "C:/???": [
        { name: "???.mp4", type: "file", icon: "video", content: "assets/chumichumie.mp4", customIcon: "assets/videoicon4.png" }
    ],
    "C:/Meus Documentos": [
        { name: "diario.txt", type: "file", icon: "notepad", content: "Eles sabiam desde 2000." },
        { name: "hakoon_plano.txt", type: "file", icon: "notepad", content: "PLANO HAKOON: 1. N√£o morrer. 2. Culpar o Salem." },
        { name: "TOP_SECRET.txt", type: "file", icon: "notepad", content: "PARAB√âNS! VOC√ä ENTROU. O c√≥digo final √©: ROSEBUD", password: "123" },
        { name: "foto_antiga.jpg", type: "file", icon: "image", content: "https://win98icons.alexmeub.com/icons/png/image_old_gif-1.png" }, // Exemplo
        { name: "Projetos", type: "folder" },
        { name: "HELL", type: "folder", password: "REQUIEM" },
        { name: "Doom", type: "folder" }
    ],
    "C:/Meus Documentos/HELL": [
        { name: "MANS LIKE YOU SHOULD BE BURN IN THE HELL.mp4", type: "file", icon: "video", content: "assets/burnninghell.mp4", customIcon: "assets/videoicon2.png" }
    ],
    "C:/Meus Documentos/Doom": [
        { name: "omnious.mp4", type: "file", icon: "video", content: "assets/bellsofdoom.mp4", customIcon: "assets/videoicon3.png" }
    ],
    "C:/Windows": [
        { name: "System32", type: "folder" },
        { name: "boot.ini", type: "file", icon: "system", content: "[boot loader]\ntimeout=30" },
        { name: "GOD", type: "folder" },
        { name: "N/A", type: "folder" }
    ],
    "C:/Windows/N/A": [
    { name: "ERRO474.txt", type: "file", icon: "notepad", content: "√â5u√∏\"√é@≈†q√ß√å0-√µ√ú√£G9‚Äîxz√≠A√£S¬¨‚Äò{h√ë¬±√±√é¬•√àl¬∞)ÀÜ√ã¬ß√Ø√ü{O¬Ω|+hI¬™0√∫hKe]'¬´√¢w¬Ø√º¬∫√≠√Ü√§√ó[JEÀú¬°S‚Ä†¬∏√ß:{SeK9AÀÜ ¬º$De¬ÆF≈íe‚Äô¬Ω√î√•√ó}√∞l√ÇP¬±U√Ä¬•‚Ç¨X¬æ√á\"¬ª¬±√è¬∑¬¢√π¬∏o sÀÜ√Ü‚ÄπX‚Ñ¢z √∫√öb√ãP5‚Ä∞√¥I¬∏!:‚Äù¬¶√Ñ√ê`LH¬Ω¬£√Ü¬¥.Dk-(‚Äô¬¨9k'D|‚Ä†‚Ç¨<√é√Ö√∂√π‚Ä¢≈ΩDVxw¬±M¬Ω√ú‚Äû≈†‚Äπ¬¨√§b++D'‚Ä∫√ª√¥√ô/>‚Ä†√£¬∏√ä√õ‚Ç¨~≈†√óai‚Äú√∑'‚Ñ¢√π√éK√Ñ√•¬∫¬µ   {ME} √ü¬ÆO¬∏]√ä√Ö√Ü¬ØU[√ô√îPY√Ñ¬∏¬π{1√Ü¬≤d¬æw√ñ≈†√Ä√∏√ï¬•√äk¬πLHk‚Äì/¬©¬ß‚Ñ¢√øCE$¬±b    √â√í]√π√æ$√ñ√õ√∞¬≥]$2¬≥¬Æ4o√î¬∏√ç]c≈†W√§√ïP‚Ñ¢√ó√ºy5^¬Ø∆í¬©≈°≈ìW≈°h‚Ä∫≈°‚Ä¢\"i√¶‚Ä°c√ç¬Ω9¬¶√çyqPk-√î√Ø|T√º‚Ä∫A¬∞‚Ç¨≈ΩMv√©C@‚Äò\"√ÇO‚Ä¶Qj √êL%‚Ä¢=Y)¬§S6543‚Äû√≤o0‚ÄúG¬º)ÀÜ¬Ø¬∏U¬¢√¢Y√∂{AJUDA}~¬ª+√≠√Æ¬ælwZ√±‚Ä°√¶√ùx√¢√∂√ì¬¢≈†√§zuwy√çm¬±¬º6w√ª√ÉZG&√•¬Æ√±√ó¬π¬∞√ü≈Ω√º√Ω¬≤S1N)Qu‚Ä¢‚Äùy√êL$,≈†√ã¬¥¬≥√Çs≈ì√™ √∫√ö√â√ÑQ@¬°;!√ô3Zn√≠¬≤‚Äö√ä%√™¬™o√ì√ñ√ä‚Äì√ú√≥√ú√ö√ïytTY‚Ä∞¬∂2√ï¬¢P√™√ô√ß√ì1√Ñ√É<√ì√ò¬≥b=√ï6xl¬±√ç√§≈†2Aa¬æ‚Ä∫,(¬¶j≈ì/¬™√¶    &K√ôE≈†√¥√ºF√¥¬¶√Å√ØK√∞√ôH|'√í‚Ä∫<¬∫V‚Äú√™≈∏¬≤0q¬©¬™d)√ë√™gbE‚Äî√ñ¬æ√ê √µ[ O≈ΩÀÜ #√Ül~√∫√èi¬Æ)¬¥√Ü√≤q√ô ¬ø¬•¬¶¬º√ñ √ç\"J¬¶≈°√ñL¬¨√µ!√≠≈∏8√ßI√öF√∑‚ÄôbrO‚Äúm@I:√î¬∞=¬∫¬π√ªw√ä4 ¬Ω¬•√°+‚Ä∞√≥¬∏(√ì8Zm%¬≥\"t@√Ö$√àK¬¶Q√ú√¶≈∏M,s‚Äô)3¬π√û√∑≈°(‚ÄöR√º≈ì√∫√ß√§√∏√£/@√ø√ã0v√èT√≠Àú‚Ñ¢√∞√±√û√õ√ñ¬Ω√ß[√¶>¬ß√∫‚Ä° √≥√í¬π¬•Ey¬±1√õ{√øÀÜ0c√ëd‚Äì√ÑL‚Äö&√¶√¥o√®v.D‚Äπx¬ª√ç√ßp-√∫√¢√±≈†Gag¬™nÀúf¬≤‚Äò√ÖD√ØhL<¬´ap z‚Ä°¬°√®√´!LmE√û‚Ä¶h‚Ä¢√¶4≈ì‚Äö¬∑M' ¬Ø!¬∂√†~X¬©√ïf¬π7^x√å¬∫¬∂i¬Æf O≈ìd¬æ√öB.D≈í{ISSO}¬§¬¶k√à√®S√ò¬¨@‚ÄôHNw√åK‚Äö√Æ¬æ‚Äì<B¬¨√°√é√≥bPo√§ S#Sjo√¥√º¬π≈°√ß@√ñ!kr¬§¬¨3¬∞D√üT≈Ω‚Äôa√â√©Jlr√∞‚ÄûaI¬¥√∞¬≤ÀÜ√àGMf‚ÄöH¬Ω√∏L.√∞√áq‚Ä°'U5f≈æ√∑6r√ò¬∫]:7BÀú√Ög√∑∆í√áa√®‚Äì√´)!√ëQ{DOI}ev√®]    √ß¬¥¬ØhÀú1¬º√ô‚Ä∞,√Å¬Æ‚Ç¨I;7s√≥√ÆM√Ø:¬±√ú√Ω√∂≈í‚Ñ¢√ò‚Ä¢6~w≈ìK¬´vIP√π√π¬¢‚Äù√•¬øJ¬∫M¬∏√®3J{DEMI}Im,√ÜL¬Ω¬Æ√≠‚Ñ¢d√£L√ª-√´‚Ä¶√æ¬Øz¬∏√ô‚Äú¬∏√ÅHAlDOIm:∆í5√£≈ìD¬¨@&    g‚Ç¨4e√õ√∑‚Äò√Ä√çO%√ê√µ√î√¶√Ö√Ø√ûO¬∑‚Äû≈æ/√ûkA√∑√û‚Äπ0√¢r√¢2√π7O‚Äô#(_dI3‚Äö√íW,1ÀÜ√ö‚ÄöE¬∫;_0'√É√Ä0e P¬°√®z¬¥√ó3 √¢!z‚Äùe√û‚Äπc‚Ç¨√òÀú√®‚Ä°√§¬∏S√ä¬´:{y‚Ñ¢;√∑¬æzj√º√µlY‚Ä°)D@ Hy¬™√í¬§¬≤F^√é√æ1 √á'+P¬Ø√ìz‚Ä°h√à¬∏√Ø5[‚Ä∞ √û--√æ‚Ñ¢√µ¬Ω√¶*c‚Äπd√ò√§¬®√à√≠k√ä"
 }
],
    "C:/Windows/System32": [
        { name: "LOG_00", type: "folder" }
    ],
    "C:/Windows/GOD": [
        { name: "THE REQUIEM OF SKYGOD.mp4", type: "file", icon: "video", content: "assets/REQUIEM.mp4", customIcon: "assets/videoicon.png" }
    ],
    "C:/Windows/System32/LOG_00": [
        { name: "KAZHAS", type: "folder", password: "ME AJUDA ISSO DOI DEMI" }
    ],
    "C:/Windows/System32/LOG_00/KAZHAS": [
        { name: "documentoestudante1", type: "file", icon: "image", content: "assets/documento_de_estudante_1_1.png" },
        { name: "documentoestudante2", type: "file", icon: "image", content: "assets/documento_de_estudante_1_1 copy.png" },
        { name: "documentoestudante3", type: "file", icon: "image", content: "assets/documento_nicolas.png" },
        { name: "documentoestudante4", type: "file", icon: "image", content: "assets/documento_de_estudante4.png" }
    ],
    "C:/Arquivos de Programas": [
        { name: "Internet Explorer", type: "folder" },
        { name: "Paint", type: "folder" }
    ],
    "C:/Meus Documentos/Projetos": [
        { name: "projeto_skyfall.doc", type: "file", icon: "word" }
    ]
};

function openExplorer() {
    if(typeof play === 'function') play();
    explorerWindow.style.display = 'flex';
    explorerWindow.style.zIndex = '165';
    const startMenu = document.getElementById('startMenu');
    if(startMenu) startMenu.style.display = 'none';
    renderExplorer(currentPath);
}

function closeExplorer() { 
    explorerWindow.style.display = 'none'; 
}

function renderExplorer(path) {
    currentPath = path;
    if(expAddress) expAddress.value = path;
    expContent.innerHTML = "";
    
    if(!fileSystem[path]) fileSystem[path] = [];

    const items = fileSystem[path];
    
    if(items.length === 0) {
        expContent.innerHTML = "<p style='padding:10px; color:#555;'>Pasta vazia.</p>";
        return;
    }

    items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'exp-item';
        
        let iconSrc = '';
        
        // L√≥gica de √çcone Personalizado
        if(item.customIcon) {
            iconSrc = item.customIcon;
        } else {
            if(item.type === 'folder') iconSrc = 'https://win98icons.alexmeub.com/icons/png/directory_closed-4.png';
            else if(item.icon === 'notepad') iconSrc = 'https://win98icons.alexmeub.com/icons/png/notepad-2.png';
            else if(item.icon === 'image') iconSrc = 'https://win98icons.alexmeub.com/icons/png/image_old_gif-1.png';
            else if(item.icon === 'video') iconSrc = 'https://win98icons.alexmeub.com/icons/png/movie_file-2.png';
            else if(item.icon === 'system') iconSrc = 'https://win98icons.alexmeub.com/icons/png/settings_gear-0.png';
            else iconSrc = 'https://win98icons.alexmeub.com/icons/png/document-0.png';
        }

        div.innerHTML = `<img src="${iconSrc}"><span>${item.name}</span>`;
        
        div.onclick = () => {
             document.querySelectorAll('.exp-item').forEach(e => e.classList.remove('selected'));
             div.classList.add('selected');
        };
        
        div.ondblclick = () => handleItemOpen(item);
        
        expContent.appendChild(div);
    });
}

// --- VISUALIZADOR DE IMAGEM ---
const imgViewerWindow = document.getElementById('imgViewerWindow');
const imgContent = document.getElementById('imgContent');
const imgViewerTitle = document.getElementById('imgViewerTitle');
const imgZoomDisplay = document.getElementById('imgZoomDisplay');
const imgViewport = document.getElementById('imgViewport');

let currentImgList = [];
let currentImgIndex = 0;
let imgScale = 1;
let imgX = 0;
let imgY = 0;
let isDraggingImg = false;
let imgStartX, imgStartY;
let isSpacePressedImg = false;

function openImageViewer(item, folderPath) {
    play();
    
    currentImgList = fileSystem[folderPath].filter(f => f.type === 'file' && f.icon === 'image');
    currentImgIndex = currentImgList.findIndex(f => f.name === item.name);
    
    if(currentImgIndex === -1) {
        currentImgList = [item];
        currentImgIndex = 0;
    }

    resetImgView();
    updateImgContent();
    
    imgViewerWindow.style.display = 'flex';
    imgViewerWindow.style.zIndex = '250';
    document.getElementById('startMenu').style.display = 'none';
}

function updateImgContent() {
    const file = currentImgList[currentImgIndex];
    imgViewerTitle.innerText = file.name + " - Visualizador";
    imgContent.src = file.content;
}

function resetImgView() {
    imgScale = 1; imgX = 0; imgY = 0;
    updateImgTransform();
}

function updateImgTransform() {
    imgContent.style.transform = `translate(${imgX}px, ${imgY}px) scale(${imgScale})`;
    imgZoomDisplay.innerText = Math.round(imgScale * 100) + "%";
}

function nextImg() {
    play();
    currentImgIndex++;
    if(currentImgIndex >= currentImgList.length) currentImgIndex = 0;
    resetImgView();
    updateImgContent();
}

function prevImg() {
    play();
    currentImgIndex--;
    if(currentImgIndex < 0) currentImgIndex = currentImgList.length - 1;
    resetImgView();
    updateImgContent();
}

function closeImgViewer() {
    imgViewerWindow.style.display = 'none';
}

// Eventos de Zoom e Pan para Imagem
imgViewport.addEventListener('wheel', (e) => {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    imgScale = Math.min(Math.max(0.1, imgScale + delta), 5);
    updateImgTransform();
});

document.addEventListener('keydown', (e) => {
    if(e.code === 'Space' && imgViewerWindow.style.display === 'flex') {
        isSpacePressedImg = true;
        imgViewport.style.cursor = 'grab';
    }
});
document.addEventListener('keyup', (e) => {
    if(e.code === 'Space') {
        isSpacePressedImg = false;
        imgViewport.style.cursor = 'default';
        isDraggingImg = false;
    }
});

imgViewport.addEventListener('mousedown', (e) => {
    if(isSpacePressedImg) {
        isDraggingImg = true;
        imgViewport.style.cursor = 'grabbing';
        imgStartX = e.clientX - imgX;
        imgStartY = e.clientY - imgY;
    }
});
window.addEventListener('mousemove', (e) => {
    if(isDraggingImg && imgViewerWindow.style.display === 'flex') {
        imgX = e.clientX - imgStartX;
        imgY = e.clientY - imgStartY;
        updateImgTransform();
    }
});
window.addEventListener('mouseup', () => {
    if(isDraggingImg) {
        isDraggingImg = false;
        imgViewport.style.cursor = isSpacePressedImg ? 'grab' : 'default';
    }
});

// --- PLAYER DE V√çDEO (L√ìGICA) ---
const videoPlayerWindow = document.getElementById('videoPlayerWindow');
const videoContent = document.getElementById('videoContent');

function openVideoPlayer(item) {
    play();
    document.getElementById('videoPlayerTitle').innerText = item.name + " - Media Player";
    videoContent.src = item.content;
    videoPlayerWindow.style.display = 'flex';
    videoPlayerWindow.style.zIndex = '260';
    videoContent.play();
    document.getElementById('startMenu').style.display = 'none';
}

function closeVideoPlayer() {
    videoPlayerWindow.style.display = 'none';
    videoContent.pause();
    videoContent.src = "";
    isSilentMode = false; // Garante que Spantu volte a falar
}

// --- LOGICA SILENCIO SPANTU ---
let isSilentMode = false;

videoContent.onplay = function() {
    isSilentMode = true;
    synth.cancel(); // Para fala atual
    buddyBubble.style.display = 'none'; // Esconde bal√£o atual
};

videoContent.onpause = function() {
    isSilentMode = false;
};

videoContent.onended = function() {
    isSilentMode = false;
};


function handleItemOpen(item) {
    if(item.password) {
        play();
        const inputPass = prompt("ARQUIVO PROTEGIDO. Digite a senha:");
        if(inputPass !== item.password) {
            buddyTalk("Senha incorreta! Acesso negado.");
            alert("Senha incorreta!");
            return; 
        }
        buddyTalk("Senha correta. Acesso liberado.");
    }

    if(item.type === 'folder') {
        const separator = currentPath.endsWith('/') ? '' : '/';
        renderExplorer(currentPath + separator + item.name);
    } else {
        if(item.icon === 'notepad') {
            openTextEditor(item);
            if(item.name === 'diario.txt') localStorage.setItem('lore1','true');
            if(item.name === 'segredos.log') localStorage.setItem('lore2','true');
        } else if(item.icon === 'image') {
            openImageViewer(item, currentPath);
        } else if(item.icon === 'video') {
            openVideoPlayer(item);
        } else {
            buddyTalk("N√£o tenho programa para abrir " + item.name);
        }
    }
}

// FUNCIONALIDADES DE CRIA√á√ÉO
function expNewFolder() {
    play();
    const name = prompt("Nome da nova pasta:", "Nova Pasta");
    if(name) {
        if(fileSystem[currentPath].find(i => i.name === name)) {
            alert("J√° existe algo com esse nome!");
            return;
        }
        fileSystem[currentPath].push({ name: name, type: "folder" });
        const separator = currentPath.endsWith('/') ? '' : '/';
        fileSystem[currentPath + separator + name] = [];
        renderExplorer(currentPath);
    }
}

function expNewFile() {
    play();
    const name = prompt("Nome do arquivo de texto:", "Novo Texto.txt");
    if(name) {
        if(fileSystem[currentPath].find(i => i.name === name)) {
            alert("J√° existe um arquivo com esse nome!");
            return;
        }
        const pass = prompt("Deseja colocar uma senha? (Deixe em branco para nenhuma)");
        const newFile = { name: name, type: "file", icon: "notepad", content: "" };
        if(pass && pass.trim() !== "") {
            newFile.password = pass; 
            buddyTalk("Arquivo criado com senha!");
        }
        fileSystem[currentPath].push(newFile);
        renderExplorer(currentPath);
    }
}

function expNewImage() {
    play();
    document.getElementById('expImgUpload').click();
}

// L√≥gica de √çcone Personalizado
let tempVideoFile = null;

function processExpImage(input) {
    const file = input.files[0];
    if(!file) return;

    if(fileSystem[currentPath].find(i => i.name === file.name)) {
        alert("J√° existe um arquivo com esse nome nesta pasta!");
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const base64 = e.target.result;
        let fileIcon = "image";
        
        // Verifica se √© v√≠deo
        if(file.type.startsWith('video/')) {
            fileIcon = "video";
            
            // Pergunta sobre √≠cone personalizado
            const wantCustomIcon = confirm("Deseja escolher um √≠cone personalizado para este v√≠deo?");
            if(wantCustomIcon) {
                // Guarda o arquivo temporariamente e abre o seletor de √≠cone
                tempVideoFile = {
                    name: file.name,
                    type: "file",
                    icon: "video",
                    content: base64
                };
                document.getElementById('customIconInput').click();
                input.value = '';
                return; // Para aqui e espera o segundo input
            }
        }

        // Salva normal se n√£o for v√≠deo ou n√£o quiser √≠cone custom
        fileSystem[currentPath].push({
            name: file.name,
            type: "file",
            icon: fileIcon,
            content: base64 
        });
        renderExplorer(currentPath);
        if(fileIcon === 'video') buddyTalk("V√≠deo importado!");
        else buddyTalk("Imagem importada!");
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function processCustomIcon(input) {
    const file = input.files[0];
    if(!file || !tempVideoFile) {
        input.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        const iconBase64 = e.target.result;
        
        // Adiciona a propriedade customIcon ao objeto
        tempVideoFile.customIcon = iconBase64;
        
        // Salva no sistema
        fileSystem[currentPath].push(tempVideoFile);
        
        renderExplorer(currentPath);
        buddyTalk("V√≠deo com √≠cone personalizado importado!");
        
        // Limpa
        tempVideoFile = null;
    };
    reader.readAsDataURL(file);
    input.value = '';
}


function expBack() {
    play();
    if(currentPath === "C:") return;
    const parts = currentPath.split('/');
    parts.pop();
    const newPath = parts.join('/') || "C:";
    renderExplorer(newPath);
}

function expUp() { expBack(); }

// --- EDITOR DE TEXTO SIMPLES ---
const textEditorWindow = document.getElementById('textEditorWindow');
const notepadArea = document.getElementById('notepad-area');
const textEditorTitle = document.getElementById('textEditorTitle');

function openTextEditor(item) {
    play();
    editingFile = item;
    textEditorTitle.innerText = item.name + " - Bloco de Notas";
    notepadArea.value = item.content || "";
    textEditorWindow.style.display = 'flex';
    textEditorWindow.style.zIndex = '170';
}

function saveCurrentFile() {
    if(editingFile) {
        editingFile.content = notepadArea.value;
        play();
        buddyTalk("Arquivo salvo.");
    }
}

function closeTextEditor() {
    textEditorWindow.style.display = 'none';
    editingFile = null;
}

// --- L√ìGICA DE APPS E JANELAS ---
function openApp(t,u){ play(); const w=document.getElementById('appWindow'); document.getElementById('appTitle').innerText=t; document.getElementById('appFrame').src=u; w.style.display='flex'; w.style.zIndex='150'; document.getElementById('startMenu').style.display='none'; }
function closeApp(){ document.getElementById('appWindow').style.display='none'; document.getElementById('appFrame').src=''; }

// --- CALCULADORA ---
let currentInput = '0'; let previousInput = ''; let operation = null; const calcScreen = document.getElementById('calcDisplay');
function openCalc() { play(); const w = document.getElementById('calcWindow'); w.style.display = 'block'; w.style.zIndex = '170'; document.getElementById('startMenu').style.display = 'none'; buddyTalk("Matem√°tica? Argh."); }
function closeCalc() { document.getElementById('calcWindow').style.display='none'; }
function updateCalcScreen() { calcScreen.value = currentInput.substring(0, 12); }
function calcNum(n) { play(); if(currentInput === '0' && n !== '.') currentInput = n; else if(n === '.' && currentInput.includes('.')) return; else currentInput += n; updateCalcScreen(); }
function calcOp(op) { play(); if(operation !== null) calcEqual(); previousInput = currentInput; operation = op; currentInput = ''; }
function calcEqual() { play(); let result; const prev = parseFloat(previousInput); const current = parseFloat(currentInput); if(isNaN(prev) || isNaN(current)) return; switch(operation) { case '+': result = prev + current; break; case '-': result = prev - current; break; case '*': result = prev * current; break; case '/': result = prev / current; break; default: return; } currentInput = result.toString(); operation = null; previousInput = ''; updateCalcScreen(); }
function calcClear() { play(); currentInput = '0'; previousInput = ''; operation = null; updateCalcScreen(); }

// --- INVESTIGA√á√ÉO ---
const notesWindow = document.getElementById('notesWindow');
const viewport = document.getElementById('board-viewport');
const boardContent = document.getElementById('board-content');
const linesLayer = document.getElementById('lines-layer');
const fileInput = document.getElementById('imgUploadInput');
let scale = 1; let panX = -200; let panY = -100;
let isSpacePressed = false; let isPanning = false; let panStartX, panStartY;

document.querySelectorAll('.board-item').forEach(el => setupBoardItem(el));
function openNotes() { play(); notesWindow.style.display = 'flex'; notesWindow.style.zIndex = '160'; document.getElementById('startMenu').style.display = 'none'; buddyTalk("Quadro aberto. Envie fotos do seu PC!"); updateTransform(); }
function closeNotes() { notesWindow.style.display = 'none'; }
viewport.addEventListener('wheel', (e) => { e.preventDefault(); const delta = e.deltaY > 0 ? -0.1 : 0.1; scale = Math.min(Math.max(0.3, scale + delta), 3); document.getElementById('zoomLevel').innerText = Math.round(scale * 100) + '%'; updateTransform(); });
document.addEventListener('keydown', (e) => { if (e.code === 'Space' && notesWindow.style.display === 'flex') { isSpacePressed = true; viewport.style.cursor = 'grab'; } });
document.addEventListener('keyup', (e) => { if (e.code === 'Space') { isSpacePressed = false; viewport.style.cursor = 'default'; isPanning = false; } });
viewport.addEventListener('mousedown', (e) => { if (isSpacePressed) { isPanning = true; viewport.style.cursor = 'grabbing'; panStartX = e.clientX - panX; panStartY = e.clientY - panY; } });
window.addEventListener('mousemove', (e) => { if (isPanning) { panX = e.clientX - panStartX; panY = e.clientY - panStartY; updateTransform(); } });
window.addEventListener('mouseup', () => { if(isPanning) { isPanning = false; viewport.style.cursor = isSpacePressed ? 'grab' : 'default'; } });
function updateTransform() { boardContent.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`; }
function resetView() { scale = 1; panX = -200; panY = -100; updateTransform(); document.getElementById('zoomLevel').innerText = '100%'; }
function addSticky() { createItem('note-yellow', prompt("Texto da nota:")); }
function triggerImgUpload() { fileInput.click(); }
fileInput.addEventListener('change', function(e) { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = function(evt) { createItem('board-photo', `<img src="${evt.target.result}">`); buddyTalk("Hmm, uma nova evid√™ncia..."); }; reader.readAsDataURL(file); } this.value = ''; });
function createItem(cls, content) { if(!content) return; const div = document.createElement('div'); div.id = 'item_' + Date.now(); div.className = 'board-item ' + cls; div.innerHTML = content; const rect = viewport.getBoundingClientRect(); const centerX = (-panX + rect.width/2) / scale; const centerY = (-panY + rect.height/2) / scale; div.style.left = (centerX - 50) + 'px'; div.style.top = (centerY - 50) + 'px'; boardContent.appendChild(div); setupBoardItem(div); play(); }
let connectingMode = false; let connectStartItem = null; let connections = [];
function toggleConnectMode() { connectingMode = !connectingMode; const btn = document.getElementById('btnConnect'); if(connectingMode) { btn.style.background = '#ffcccc'; btn.innerText = '‚ùå Cancelar'; viewport.style.cursor = 'crosshair'; buddyTalk("Clique em dois itens para conectar."); } else { btn.style.background = ''; btn.innerText = 'üîó Conectar'; viewport.style.cursor = 'default'; connectStartItem = null; document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected')); } }
function setupBoardItem(item) { if (!item.id) item.id = 'item_' + Date.now() + Math.random(); if (!item.querySelector('.delete-btn')) { const delBtn = document.createElement('div'); delBtn.className = 'delete-btn'; delBtn.innerText = 'X'; delBtn.onclick = function(e) { e.stopPropagation(); deleteItem(item); }; item.appendChild(delBtn); } item.onmousedown = function(e) { e.stopPropagation(); if (connectingMode) { handleConnectionClick(item); return; } if (isSpacePressed) return; item.style.zIndex = 1000; const sl = parseFloat(item.style.left || 0); const st = parseFloat(item.style.top || 0); const msx = e.clientX; const msy = e.clientY; function onMove(ev) { const dx = (ev.clientX - msx) / scale; const dy = (ev.clientY - msy) / scale; item.style.left = (sl + dx) + 'px'; item.style.top = (st + dy) + 'px'; updateLines(); } function onUp() { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); item.style.zIndex = ''; } document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); }; }
function deleteItem(item) { play(); connections = connections.filter(c => { if(c.from === item.id || c.to === item.id) { c.line.remove(); return false; } return true; }); item.remove(); }
function handleConnectionClick(item) { play(); if (!connectStartItem) { connectStartItem = item; item.classList.add('selected'); } else { if (connectStartItem !== item) { createLine(connectStartItem.id, item.id); toggleConnectMode(); } else { item.classList.remove('selected'); connectStartItem = null; } } }
function createLine(id1, id2) { const line = document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('stroke', '#d00'); line.setAttribute('stroke-width', '3'); line.setAttribute('stroke-opacity', '0.8'); linesLayer.appendChild(line); connections.push({ from: id1, to: id2, line: line }); updateLines(); }
function updateLines() { connections.forEach(conn => { const el1 = document.getElementById(conn.from); const el2 = document.getElementById(conn.to); if(el1 && el2) { const x1 = parseFloat(el1.style.left) + el1.offsetWidth/2; const y1 = parseFloat(el1.style.top) + el1.offsetHeight/2; const x2 = parseFloat(el2.style.left) + el2.offsetWidth/2; const y2 = parseFloat(el2.style.top) + el2.offsetHeight/2; conn.line.setAttribute('x1', x1); conn.line.setAttribute('y1', y1); conn.line.setAttribute('x2', x2); conn.line.setAttribute('y2', y2); } }); }

// --- SAVE/LOAD BOARD ---
function saveBoard() {
    const items = [];
    document.querySelectorAll('.board-item').forEach(el => {
        const content = el.innerHTML.replace(/<div class="delete-btn".*?<\/div>/, '');
        items.push({ id: el.id, left: el.style.left, top: el.style.top, classes: el.className, content: content });
    });
    const data = { items: items, connections: connections.map(c => ({from: c.from, to: c.to})), panX: panX, panY: panY, scale: scale };
    const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'investigacao_win2k.json'; a.click(); URL.revokeObjectURL(url);
    buddyTalk("Dados salvos no seu desktop real.");
}

function loadBoard(input) {
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            document.querySelectorAll('.board-item').forEach(el => el.remove());
            connections.forEach(c => c.line.remove());
            connections = [];
            data.items.forEach(item => { const div = document.createElement('div'); div.id = item.id; div.className = item.classes; div.style.left = item.left; div.style.top = item.top; div.innerHTML = item.content; boardContent.appendChild(div); setupBoardItem(div); });
            data.connections.forEach(c => { createLine(c.from, c.to); });
            panX = data.panX || -200; panY = data.panY || -100; scale = data.scale || 1;
            updateTransform(); document.getElementById('zoomLevel').innerText = Math.round(scale * 100) + '%';
            buddyTalk("Investiga√ß√£o recuperada.");
        } catch(err) { buddyTalk("Arquivo corrompido!"); }
    };
    reader.readAsText(file); input.value = '';
}

// --- DRAG GEN√âRICO ---
let ox, oy, down = false;
function setupDrag(e, win) { down = true; win.style.zIndex = '180'; ox = e.clientX - win.offsetLeft; oy = e.clientY - win.offsetTop; document.onmousemove = ev => { if (down) { win.style.left = ev.clientX - ox + 'px'; win.style.top = ev.clientY - oy + 'px'; } }; document.onmouseup = () => { down = false }; }
function drag(e) { setupDrag(e, document.getElementById('window')); }
function dragApp(e) { setupDrag(e, document.getElementById('appWindow')); }
function dragNoteWindow(e) { setupDrag(e, document.getElementById('notesWindow')); }
function dragPaint(e) { setupDrag(e, document.getElementById('paintWindow')); }
function dragCalc(e) { setupDrag(e, document.getElementById('calcWindow')); }
function dragExplorer(e) { setupDrag(e, document.getElementById('explorerWindow')); }
function dragTextEditor(e) { setupDrag(e, document.getElementById('textEditorWindow')); }
function dragImgViewer(e) { setupDrag(e, document.getElementById('imgViewerWindow')); }
function dragVideoPlayer(e) { setupDrag(e, document.getElementById('videoPlayerWindow')); }


// PAINT
const paintWindow = document.getElementById('paintWindow'); const canvas = document.getElementById('canvas'); const ctx = canvas.getContext('2d'); let painting = false; let paintColor = '#000';
ctx.lineWidth = 2; ctx.lineCap = 'round'; ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height);
function openPaint() { play(); paintWindow.style.display = 'block'; document.getElementById('startMenu').style.display = 'none'; buddyTalk("Desenhe algo bonito para mim!"); }
function closePaint() { paintWindow.style.display = 'none'; }
function setPaintColor(color) { paintColor = color; ctx.strokeStyle = color; }
function clearCanvas() { ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, canvas.width, canvas.height); }
canvas.addEventListener('mousedown', startPosition); canvas.addEventListener('mouseup', finishedPosition); canvas.addEventListener('mousemove', draw);
function startPosition(e) { painting = true; draw(e); }
function finishedPosition() { painting = false; ctx.beginPath(); }
function draw(e) { if (!painting) return; const rect = canvas.getBoundingClientRect(); const x = e.clientX - rect.left; const y = e.clientY - rect.top; ctx.strokeStyle = paintColor; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y); }

// --- BUDDY ---
const buddyBubble = document.getElementById('buddyBubble');
const buddyImg = document.getElementById('buddy-img');
const buddyContainer = document.getElementById('buddy-container');
let bubbleTimer;
let isDraggingBuddy = false;

let idleTimer = null;
let danceDurationTimer = null;
let isDancing = false;
const danceImages = ['assets/danca1.gif', 'assets/danca2.gif', 'assets/danca3.gif', 'assets/danca4.gif'];

function buddyTalk(msg) {
    if(isSilentMode) return; // Bloqueia fala no bal√£o tamb√©m
    buddyBubble.innerText = msg;
    buddyBubble.style.display = 'block';
    speakText(msg); 
    clearTimeout(bubbleTimer);
    bubbleTimer = setTimeout(() => { buddyBubble.style.display = 'none'; }, 4000); 
}

function interactBuddy() {
    if(isSilentMode) return;
    stopDance();
    if (isDraggingBuddy) return;
    const interacoes = ["Isso faz c√≥cegas!", "Estou processando dados...", "Uiiii! N√£o me aperte."];
    const r = Math.floor(Math.random() * interacoes.length);
    buddyTalk(interacoes[r]);
}

let bOx, bOy, bDown = false;
function dragBuddy(e) {
    e.stopPropagation();
    stopDance();
    bDown = true;
    isDraggingBuddy = false;
    const startX = e.clientX;
    const startY = e.clientY;
    if (!buddyContainer.style.left) { buddyContainer.style.left = buddyContainer.offsetLeft + 'px'; buddyContainer.style.top = buddyContainer.offsetTop + 'px'; buddyContainer.style.bottom = 'auto'; buddyContainer.style.right = 'auto'; }
    bOx = e.clientX - buddyContainer.offsetLeft;
    bOy = e.clientY - buddyContainer.offsetTop;

    document.onmousemove = ev => {
        if (bDown) {
            if (Math.abs(ev.clientX - startX) > 3 || Math.abs(ev.clientY - startY) > 3) {
                if(isDancing) stopDance();
                if(!isDraggingBuddy) {
                    isDraggingBuddy = true;
                    buddyContainer.classList.add('buddy-dragging');
                    buddyImg.src = 'assets/spantu_drag.png'; 
                    buddyTalk("Aonde vamos?");
                }
            }
            buddyContainer.style.left = (ev.clientX - bOx) + 'px';
            buddyContainer.style.top = (ev.clientY - bOy) + 'px';
        }
    }
    document.onmouseup = () => { if (bDown) { bDown = false; buddyContainer.classList.remove('buddy-dragging'); if(!isDancing) { buddyImg.src = 'assets/spantu.png'; } setTimeout(() => { isDraggingBuddy = false; }, 100); resetIdleTimer(); } }
}

function resetIdleTimer() { if (idleTimer) clearTimeout(idleTimer); idleTimer = setTimeout(() => { startDance(); }, 180000); }
function stopDance() { if(!isDancing) return; isDancing = false; if(danceDurationTimer) clearTimeout(danceDurationTimer); buddyImg.src = 'assets/spantu.png'; resetIdleTimer(); }
function startDance() {
    if (isSilentMode || isDancing || isDraggingBuddy || document.getElementById('bsod').style.display === 'block') { resetIdleTimer(); return; }
    isDancing = true; buddyTalk("Hora do show!");
    const randomIndex = Math.floor(Math.random() * danceImages.length);
    buddyImg.src = danceImages[randomIndex]; 
    danceDurationTimer = setTimeout(() => { stopDance(); }, 30000);
}

function startRandomTalkLoop() {
    setTimeout(() => {
        if (!isSilentMode && !isDancing && !isDraggingBuddy && Math.random() > 0.7) {
            const randomPhrases = ["Vai tomar no cu hakoon", "Tem algo errado com a lixeira...", "Voc√™ viu? Piscou.", "Bip bop... eu odeio essa tela.", "Por que voc√™ n√£o abre o segredo?", "Eu sinto o shadow no meu brioco.", "O mouse parou de mexer... brincadeira.", "Hakoon precisa de um caf√©.", "Inicializando sistema‚Ä¶ erro encontrado: Hakoon pensando demais. Reiniciando.", "Hakoon, se concentra√ß√£o queimasse caloria voc√™ j√° tinha virado um deus menor.", "Salem entrou na sala. Estat√≠sticas atualizadas: chance de dar ruim aumentou em 73%.", "Guilherme, seu plano √© ousado‚Ä¶ ousadamente errado.", "Let√≠cia desbloqueou a habilidade passiva 'parece normal at√© falar'.", "Analisando grupo‚Ä¶ conclus√£o: isso n√£o √© uma party, √© um experimento social.", "Hakoon, voc√™ quer uma estrat√©gia ou um milagre? Porque s√≥ um deles eu posso tentar.", "Salem dizendo 'confia em mim' detectado. Protocolo de p√¢nico ativado.", "Guilherme, parab√©ns, voc√™ conseguiu errar algo que nem tinha teste.", "Let√≠cia, seu sil√™ncio √© preocupante. Geralmente ele antecede uma ideia perigosa.", "Atualiza√ß√£o do sistema: nenhum de voc√™s leu o manual. De novo.", "Hakoon tentando liderar. Resultado: democracia entrou em colapso.", "Salem tem uma ideia. Estatisticamente, isso √© uma amea√ßa.", "Guilherme, voc√™ apertou o bot√£o errado. N√£o. O outro errado.", "Let√≠cia, voc√™ percebeu algo importante‚Ä¶ pena que ningu√©m vai ouvir.", "Rodando diagn√≥stico emocional‚Ä¶ todos est√£o confiantes. Isso √© ruim.", "Hakoon, sua coragem √© admir√°vel. Sua no√ß√£o das consequ√™ncias, n√£o.", "Salem age primeiro, pensa depois. √Äs vezes nem isso.", "Guilherme, sua sorte est√° abaixo de zero. Isso nem deveria ser poss√≠vel.", "Let√≠cia, voc√™ √© a voz da raz√£o‚Ä¶ num grupo que ignora a raz√£o.", "Simula√ß√£o de futuro em andamento‚Ä¶ resultado: gritos.", "Hakoon, voc√™ n√£o est√° errado. S√≥ est√° perigosamente otimista.", "Salem, isso n√£o √© um plano, √© um pedido de desculpas antecipado.", "Guilherme conseguiu sobreviver. Estat√≠stica improv√°vel registrada.", "Let√≠cia, voc√™ acabou de salvar todo mundo sem perceber. De novo.", "Analisando chances de sucesso‚Ä¶ recalculando‚Ä¶ rindo‚Ä¶ recalculando.", "Voc√™s sabiam que 90% das trag√©dias come√ßam exatamente assim?", "Nota mental: nunca confiar nesse grupo com bot√µes vermelhos.", "Se der tudo certo, foi sem querer.", "Se der tudo errado‚Ä¶ bom, voc√™s j√° esperavam.", "Encerrando fala motivacional: boa sorte. Voc√™s v√£o precisar mais do que eu.", "Demiurgo esta observando, cuidado", "Gostamos de rosa, hehe", "Sabia que cadeirantes morrem ao cair de um canyon? Interessante hehe", "Uma amea√ßa foi detectada"];
            const r = Math.floor(Math.random() * randomPhrases.length);
            buddyTalk(randomPhrases[r]);
        }
        startRandomTalkLoop();
    }, 5000 + Math.random() * 5000);
}
resetIdleTimer();

// --- WALLPAPER E SAVE SYSTEM ---
function triggerWallpaperUpload() { document.getElementById('wallpaperInput').click(); document.getElementById('startMenu').style.display='none'; }
function updateWallpaper(input) {
    const file = input.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) { document.getElementById('desktop').style.backgroundImage = `url('${e.target.result}')`; buddyTalk("Bela escolha de decora√ß√£o!"); };
        reader.readAsDataURL(file);
    }
    input.value = ''; 
}

const desktopDiv = document.getElementById('desktop');
const contextMenu = document.getElementById('contextMenu');
desktopDiv.addEventListener('contextmenu', function(e) {
    if (e.target.closest('.window') || e.target.closest('.icon') || e.target.closest('.taskbar') || e.target.closest('#buddy-container')) return;
    e.preventDefault();
    contextMenu.style.display = 'block';
    let x = e.clientX; let y = e.clientY;
    if(x + 200 > window.innerWidth) x -= 200;
    contextMenu.style.left = x + 'px'; contextMenu.style.top = y + 'px';
});
window.addEventListener('click', function() { if(contextMenu) contextMenu.style.display = 'none'; });

function saveSystem() {
    play();
    const currentWallpaper = document.getElementById('desktop').style.backgroundImage;
    const saveState = {
        timestamp: Date.now(),
        fileSystem: fileSystem,
        wallpaper: currentWallpaper,
        settings: { unlocked: localStorage.getItem('unlocked'), lore1: localStorage.getItem('lore1'), lore2: localStorage.getItem('lore2') }
    };
    const blob = new Blob([JSON.stringify(saveState)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'backup_windows2000_' + new Date().toISOString().slice(0,10) + '.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    buddyTalk("Backup do sistema salvo! Guarde bem.");
}

function loadSystem(input) {
    play();
    const file = input.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            if(data.fileSystem) {
                fileSystem = data.fileSystem;
                if(document.getElementById('explorerWindow').style.display === 'flex') { renderExplorer(currentPath); }
            }
            if(data.wallpaper) { document.getElementById('desktop').style.backgroundImage = data.wallpaper; }
            if(data.settings) {
                if(data.settings.unlocked) localStorage.setItem('unlocked', data.settings.unlocked);
                if(data.settings.lore1) localStorage.setItem('lore1', data.settings.lore1);
                if(data.settings.lore2) localStorage.setItem('lore2', data.settings.lore2);
            }
            buddyTalk("Sistema restaurado com sucesso!");
        } catch(err) { console.error(err); buddyTalk("Erro ao ler o arquivo."); alert("Erro: Arquivo inv√°lido."); }
    };
    reader.readAsText(file); input.value = ''; 
}
</script>
</body>
</html>